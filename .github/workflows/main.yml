name: Java Calculator Test Automation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Run tests with Maven
      run: mvn clean test
      continue-on-error: true

    - name: Generate Allure Report
      run: mvn allure:report

    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: target/allure-results
        retention-days: 30

    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: target/site/allure-maven-plugin
        retention-days: 30

    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: |
          target/surefire-reports/*.xml

    - name: Deploy Allure Report to GitHub Pages
      if: github.ref == 'refs/heads/main' && always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: target/site/allure-maven-plugin
        publish_branch: gh-pages
        keep_files: true

    - name: Post results to Zephyr Scale
      if: always()
      env:
        ZEPHYR_API_TOKEN: ${{ secrets.ZEPHYR_API_TOKEN }}
        ZEPHYR_PROJECT_KEY: ${{ secrets.ZEPHYR_PROJECT_KEY }}
      run: |
        echo "Posting test results to Zephyr Scale..."
        
        # Install jq for JSON processing
        sudo apt-get update && sudo apt-get install -y jq
        
        # Create test cycle in Zephyr
        CYCLE_NAME="GitHub Actions Run - $(date +'%Y-%m-%d %H:%M:%S')"
        echo "Creating test cycle: ${CYCLE_NAME}"
        
        CYCLE_RESPONSE=$(curl -X POST "https://api.zephyrscale.smartbear.com/v2/testcycles" \
          -H "Authorization: Bearer ${ZEPHYR_API_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"projectKey\": \"${ZEPHYR_PROJECT_KEY}\",
            \"name\": \"${CYCLE_NAME}\",
            \"description\": \"Automated test run from GitHub Actions\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\nWorkflow: ${{ github.workflow }}\"
          }")
        
        CYCLE_KEY=$(echo $CYCLE_RESPONSE | jq -r '.key')
        
        if [ "$CYCLE_KEY" != "null" ] && [ -n "$CYCLE_KEY" ]; then
          echo "âœ… Test cycle created: ${CYCLE_KEY}"
          
          # Post each test execution to Zephyr
          for testfile in target/surefire-reports/TEST-*.xml; do
            if [ -f "$testfile" ]; then
              echo "Processing test results from: $testfile"
              
              # Extract test results and post to Zephyr
              python3 -c "
import xml.etree.ElementTree as ET
import requests
import os
import sys

token = os.environ['ZEPHYR_API_TOKEN']
project_key = os.environ['ZEPHYR_PROJECT_KEY']
cycle_key = '${CYCLE_KEY}'

tree = ET.parse('$testfile')
root = tree.getroot()

for testcase in root.findall('testcase'):
    test_name = testcase.get('name')
    time = float(testcase.get('time', 0))
    
    # Map test method to Zephyr test case key
    test_key_map = {
        'testAddPositiveNumbers': 'CALC-001',
        'testAddWithNegative': 'CALC-002',
        'testSubtract': 'CALC-003',
        'testMultiply': 'CALC-004',
        'testDivide': 'CALC-005',
        'testDivideByZero': 'CALC-006',
        'testModulo': 'CALC-007',
        'testModuloByZero': 'CALC-008',
        'testPower': 'CALC-009',
        'testSquareRoot': 'CALC-010',
        'testSquareRootNegative': 'CALC-011'
    }
    
    test_case_key = test_key_map.get(test_name, f'CALC-{hash(test_name) % 900 + 100:03d}')
    
    # Determine status
    if testcase.find('failure') is not None:
        status = 'Fail'
        failure = testcase.find('failure')
        comment = f'Failed: {failure.get(\"message\", \"Unknown error\")}'
    elif testcase.find('error') is not None:
        status = 'Fail'
        error = testcase.find('error')
        comment = f'Error: {error.get(\"message\", \"Unknown error\")}'
    elif testcase.find('skipped') is not None:
        status = 'Blocked'
        comment = 'Test was skipped'
    else:
        status = 'Pass'
        comment = 'Test executed successfully'
    
    # Post to Zephyr
    payload = {
        'projectKey': project_key,
        'testCaseKey': test_case_key,
        'testCycleKey': cycle_key,
        'statusName': status,
        'executionTime': int(time * 1000),
        'comment': comment
    }
    
    try:
        response = requests.post(
            'https://api.zephyrscale.smartbear.com/v2/testexecutions',
            headers={
                'Authorization': f'Bearer {token}',
                'Content-Type': 'application/json'
            },
            json=payload
        )
        
        if response.status_code in [200, 201]:
            print(f'âœ… Posted {test_case_key}: {status}')
        else:
            print(f'âš ï¸ Failed to post {test_case_key}: {response.status_code}')
    except Exception as e:
        print(f'âŒ Error posting {test_case_key}: {str(e)}')
"
            fi
          done
          
          echo "âœ… All test results posted to Zephyr Scale"
          echo "View results at: https://smartbear.com/test-management/zephyr-scale"
        else
          echo "âŒ Failed to create test cycle in Zephyr"
          echo "Response: ${CYCLE_RESPONSE}"
        fi

    - name: Comment PR with test results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = '## ğŸ§ª Test Results\n\n';
          
          try {
            const reportFiles = fs.readdirSync('target/surefire-reports')
              .filter(f => f.endsWith('.xml'));
            
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;
            
            reportFiles.forEach(file => {
              const content = fs.readFileSync(
                path.join('target/surefire-reports', file), 
                'utf8'
              );
              
              const testsMatch = content.match(/tests="(\d+)"/);
              const failuresMatch = content.match(/failures="(\d+)"/);
              
              if (testsMatch) totalTests += parseInt(testsMatch[1]);
              if (failuresMatch) failedTests += parseInt(failuresMatch[1]);
            });
            
            passedTests = totalTests - failedTests;
            
            comment += `- âœ… **Passed**: ${passedTests}\n`;
            comment += `- âŒ **Failed**: ${failedTests}\n`;
            comment += `- ğŸ“Š **Total**: ${totalTests}\n\n`;
            comment += `[View Allure Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            
          } catch (error) {
            comment += 'Unable to parse test results\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
