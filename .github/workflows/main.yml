name: Java Calculator Test Automation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Run tests with Maven
      run: mvn clean test
      continue-on-error: true

    - name: Generate Allure Report
      run: mvn allure:report

    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: target/allure-results
        retention-days: 30

    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: target/site/allure-maven-plugin
        retention-days: 30

    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: |
          target/surefire-reports/*.xml

    - name: Post results to Zephyr Scale
      if: always()
      env:
        ZEPHYR_API_TOKEN: ${{ secrets.ZEPHYR_API_TOKEN }}
        ZEPHYR_PROJECT_KEY: ${{ secrets.ZEPHYR_PROJECT_KEY }}
      run: |
        echo "Posting test results to Zephyr Scale..."
        
        # Install jq for JSON processing
        sudo apt-get update && sudo apt-get install -y jq
        
        # Create test cycle in Zephyr
        CYCLE_RESPONSE=$(curl -X POST "https://api.zephyrscale.smartbear.com/v2/testcycles" \
          -H "Authorization: Bearer ${ZEPHYR_API_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"projectKey\": \"${ZEPHYR_PROJECT_KEY}\",
            \"name\": \"Automated Test Run - $(date +'%Y-%m-%d %H:%M:%S')\",
            \"description\": \"Automated test execution from GitHub Actions - Commit: ${{ github.sha }}\",
            \"plannedStartDate\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",
            \"plannedEndDate\": \"$(date -u -d '+1 hour' +'%Y-%m-%dT%H:%M:%SZ')\"
          }")
        
        CYCLE_KEY=$(echo $CYCLE_RESPONSE | jq -r '.key')
        echo "Created test cycle: ${CYCLE_KEY}"
        
        # Parse test results and post to Zephyr
        for testfile in target/surefire-reports/TEST-*.xml; do
          if [ -f "$testfile" ]; then
            python3 << 'EOF'
import xml.etree.ElementTree as ET
import os
import json
import subprocess

testfile = "$testfile"
tree = ET.parse(testfile)
root = tree.getroot()

for testcase in root.findall('testcase'):
    test_name = testcase.get('name')
    class_name = testcase.get('classname')
    time = testcase.get('time')
    
    # Determine test status
    if testcase.find('failure') is not None:
        status = "Fail"
        comment = testcase.find('failure').get('message', '')
    elif testcase.find('error') is not None:
        status = "Fail"
        comment = testcase.find('error').get('message', '')
    elif testcase.find('skipped') is not None:
        status = "Blocked"
        comment = "Test was skipped"
    else:
        status = "Pass"
        comment = "Test passed successfully"
    
    # Post execution result to Zephyr
    payload = {
        "projectKey": os.environ['ZEPHYR_PROJECT_KEY'],
        "testCycleKey": os.environ['CYCLE_KEY'],
        "testCaseKey": f"CALC-{hash(test_name) % 1000:03d}",
        "statusName": status,
        "executionTime": int(float(time) * 1000),
        "comment": f"{test_name}: {comment}"
    }
    
    print(f"Posting result for: {test_name} - Status: {status}")
EOF
          fi
        done

    - name: Comment PR with test results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = '## üß™ Test Results\n\n';
          
          try {
            const reportFiles = fs.readdirSync('target/surefire-reports')
              .filter(f => f.endsWith('.xml'));
            
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;
            
            reportFiles.forEach(file => {
              const content = fs.readFileSync(
                path.join('target/surefire-reports', file), 
                'utf8'
              );
              
              const testsMatch = content.match(/tests="(\d+)"/);
              const failuresMatch = content.match(/failures="(\d+)"/);
              
              if (testsMatch) totalTests += parseInt(testsMatch[1]);
              if (failuresMatch) failedTests += parseInt(failuresMatch[1]);
            });
            
            passedTests = totalTests - failedTests;
            
            comment += `- ‚úÖ **Passed**: ${passedTests}\n`;
            comment += `- ‚ùå **Failed**: ${failedTests}\n`;
            comment += `- üìä **Total**: ${totalTests}\n\n`;
            comment += `[View Allure Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            
          } catch (error) {
            comment += 'Unable to parse test results\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
