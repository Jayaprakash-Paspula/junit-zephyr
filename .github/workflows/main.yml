name: Java CI with Maven + Allur + Zephyr

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-report:
    runs-on: ubuntu-latest

    steps:
      - name: Check for required secrets
        # This step ensures the required secrets are present before proceeding.
        run: |
          if [ -z "${{ secrets.ZEPHYR_PROJECT_KEY }}" ]; then
            echo "::error::Secret ZEPHYR_PROJECT_KEY is missing or empty. Please set it in your repository secrets."
            exit 1
          fi
          if [ -z "${{ secrets.ZEPHYR_API_TOKEN }}" ]; then
            echo "::error::Secret ZEPHYR_API_TOKEN is missing or empty. Please set it in your repository secrets."
            exit 1
          fi
      
      - name: Checkout Repository
        uses: actions/checkout@v4
    
      - name: Set up Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17' # Adjust to your project's Java version
          distribution: 'temurin'
          cache: 'maven'
    
      - name: Install required tools (zip)
        # Ubuntu runners usually have zip, but this ensures it's available
        run: sudo apt-get install zip -y
    
      - name: Make script.sh executable
        run: chmod +x ./script.sh
    
      - name: Run Maven Tests
        # The script relies on the JUnit XML files being present, so run tests first
        run: mvn test
    
      - name: Upload Results to Zephyr Scale
        id: zephyr_upload
        # Run the script, passing the secrets as arguments
        run: |
          ./script.sh "${{ secrets.ZEPHYR_PROJECT_KEY }}" "${{ secrets.ZEPHYR_API_TOKEN }}"
        
        # This step runs if 'mvn test' succeeded or failed, as test reports will be generated either way.
        if: success() || failure()
